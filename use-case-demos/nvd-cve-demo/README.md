#  Cybersecurity Graph Demo

## Summary  
This demo shows how to model cybersecurity vulnerabilities as a graph using PuppyGraph and PostgreSQL. It uses real CVE data from the [National Vulnerability Database (NVD)](https://nvd.nist.gov/), specifically the JSON 2.0 CVE 2025 feed, together with synthetic data representing typical cloud infrastructure components with EC2 instances, subnets, network interfaces, and Inspector findings. The data is loaded into PostgreSQL and mapped into a graph structure defined by a JSON schema. With PuppyGraph, you can explore relationships between vulnerabilities, assets, and attack surfaces using Cypher or Gremlin queries, enabling contextual threat investigations across your infrastructure.

## Project Structure

├── docker-compose.yaml  
├── gen_data/
│   ├── cve_json_to_csv.py
│   ├── gen_data.py
│   ├── README.md
├── postgres-init/  
│   ├── init.sql  
└── README.md  
└── schema.json

## Prerequisites:
- Docker and Docker Compose

## Data Preparation

Go to the `gen_data` directory and follow the steps in its `README.md` file. You will get a folder with CSV files containing the following data:
- `cve.csv`: CVE data extracted from the NVD JSON feed.
- `aws_inspector_findings.csv`: Simulates security findings, some of which link to real CVE IDs loaded from `cve.csv`.
- `ec2_instances.csv`: Represents virtual machine instances.
- `ec2_subnets.csv`: Simulates subnet configurations across different AWS regions and availability zones.
- `network_interfaces.csv`: Generates network interface cards (ENIs) for the instances. 
- `ec2_instance_interfaces.csv`: Defines relationships between EC2 instances and their network interfaces. 

Copy the folder with the CSV files to `./postgres-init/` directory. 
```bash
cp -r gen_data/csv_data ./postgres-init/
```

The CVE data feed is dynamic and frequently updated. Additionally, we generate varied synthetic data to simulate cloud infrastructure components, resulting in unique CSV files each time you prepare the data.


## Deployment
1. Start the Postgres services and PuppyGraph by running:
```bash
docker compose up -d
```
Example output:
```bash
[+] Running 3/3
✔ Network puppy-postgres        Created
✔ Container postgres            Started
✔ Container puppygraph          Started
```

2. Wait a few seconds for PostgreSQL to load the CSVs. Then open the PuppyGraph UI.

## Modeling the Graph
1. Log into the PuppyGraph Web UI at http://localhost:8081 with the following credentials:
- Username: `puppygraph`
- Password: `puppygraph123`

2. Upload the schema:
- Select the file `schema.json` in the **Upload Graph Schema JSON** section and click on **Upload**.
- Alternatively, you can upload the schema via the following command:
```bash
curl -XPOST -H "content-type: application/json" --data-binary @./schema.json --user "puppygraph:puppygraph123" localhost:8081/schema
```

## Querying the Graph using Cypher

Navigate to the Query panel on the left side. The Graph Query tab offers an interactive environment for querying the graph using Gremlin and Cypher.

After each query, remember to clear the graph panel before executing the next query to maintain a clean visualization.
You can do this by clicking the **Clear Canvas** button located in the top-right corner of the page.


Example Queries:
1. Find Instances Affected by a CVE.
```cypher
MATCH (c:CVE {id: "CVE-2025-5222"})<-[:HAS_VULNERABILITY]-(f:AWSInspectorFinding)
      <-[:HAS_FINDING]-(inst:EC2Instance)
RETURN inst.id               AS instance_id,
       inst.instancetype     AS instance_type,
       f.severity            AS finding_severity,
       f.last_observed_at    AS update_time
ORDER BY finding_severity DESC, inst.id;
```

Or return path
```cypher
MATCH path = (c:CVE {id: "CVE-2025-5222"})<-[:HAS_VULNERABILITY]-(f:AWSInspectorFinding)
    <-[:HAS_FINDING]-(inst:EC2Instance)
RETURN path;
```

2. List Recent High/Critical Vulnerable Instances in a Subnet.
```cypher
MATCH (sub:EC2Subnet {id: "subnet-04f9ff1508a54905"})
      <-[:PART_OF_SUBNET]-(ni:NetworkInterface)
      <-[:HAS_NETWORK_INTERFACE]-(inst:EC2Instance)
      -[:HAS_FINDING]->(f:AWSInspectorFinding)
      -[:HAS_VULNERABILITY]->(c:CVE)
WHERE f.severity IN ["HIGH","CRITICAL"] AND f.last_observed_at > datetime('2025-03-01')
RETURN inst.id               AS instance_id,
       inst.availabilityzone AS az,
       f.severity            AS finding_severity,
       c.id                  AS cve_id,
       f.last_observed_at    AS update_time
ORDER BY f.severity, f.last_observed_at DESC;
```

3. Find Neighbors of a Given Instance with Recent Vulnerability Risks.
```cypher
MATCH path = (target:EC2Instance {id: "i-03308b76dd2349b6"})
      -[:HAS_NETWORK_INTERFACE]->(targetNi:NetworkInterface)
      -[:PART_OF_SUBNET]->(sub:EC2Subnet)
      <-[:PART_OF_SUBNET]-(ni:NetworkInterface)
      <-[:HAS_NETWORK_INTERFACE]-(peer:EC2Instance)
      -[:HAS_FINDING]->(f:AWSInspectorFinding)
      -[:HAS_VULNERABILITY]->(c:CVE)
WHERE peer.id <> target.id AND f.last_observed_at > datetime('2025-05-01')
RETURN path;
```

4. Count Affected Instances per CVE per Subnet Recently.
```cypher
MATCH (c:CVE)<-[:HAS_VULNERABILITY]-(f:AWSInspectorFinding)
      <-[:HAS_FINDING]-(inst:EC2Instance)
      -[:HAS_NETWORK_INTERFACE]->(ni:NetworkInterface)
      -[:PART_OF_SUBNET]->(sub:EC2Subnet)
WHERE f.last_observed_at > datetime('2025-03-01')
RETURN sub.id                  AS subnet_id,
       c.id                    AS cve_id,
       COUNT(DISTINCT inst.id) AS affected_instances
ORDER BY affected_instances DESC, subnet_id
LIMIT 1000;
```

5. Count Critical Vulnerable Instances per Availability Zone.
```cypher
MATCH (inst:EC2Instance)-[:HAS_FINDING]->(f:AWSInspectorFinding)
      -[:HAS_VULNERABILITY]->(c:CVE)
WHERE f.severity = "CRITICAL"
RETURN inst.availabilityzone   AS az,
       COUNT(DISTINCT inst.id) AS critical_count
ORDER BY critical_count DESC;
```


## Cleanup and Teardown
To stop and remove the containers, networks, and volumes, run:
```bash
docker compose down -v
```
